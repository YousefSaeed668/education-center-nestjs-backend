model User {
  id                 Int               @id @default(autoincrement())
  userName           String            @unique
  phoneNumber        String            @unique
  password           String
  displayName        String
  profilePicture     String?
  gender             Gender
  role               Role              @default(STUDENT)
  refreshToken       String?
  balance            Decimal           @default(0) @db.Decimal(10, 2)
  admin              Admin?
  guardian           Guardian?
  student            Student?
  teacher            Teacher?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  withdrawRequests   WithdrawRequest[]
  processedWithdraws WithdrawRequest[] @relation("ProcessedWithdraws")
}

model Address {
  id              Int     @id @default(autoincrement())
  recipientName   String
  phoneNumber     String
  streetAddress   String
  postalCode      String?
  additionalNotes String?
  isDefault       Boolean @default(false)

  government   Government @relation(fields: [governmentId], references: [id])
  governmentId Int
  city         City       @relation(fields: [cityId], references: [id])
  cityId       Int

  studentId Int
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Student {
  id                       Int                      @id
  educationTypeId          Int
  secondLangId             Int
  schoolTypeId             Int
  parentPhoneNumber        String
  gradeId                  Int
  schoolName               String
  cityId                   Int
  governmentId             Int
  guardianId               Int?
  isGuardianVerified       Boolean                  @default(false)
  divisionId               Int
  Cart                     Cart?
  Order                    Order[]
  city                     City                     @relation(fields: [cityId], references: [id])
  division                 Division                 @relation(fields: [divisionId], references: [id])
  educationType            EducationType            @relation(fields: [educationTypeId], references: [id])
  government               Government               @relation(fields: [governmentId], references: [id])
  grade                    Grade                    @relation(fields: [gradeId], references: [id])
  guardian                 Guardian?                @relation(fields: [guardianId], references: [id])
  user                     User                     @relation(fields: [id], references: [id], onDelete: Cascade)
  schoolType               SchoolType               @relation(fields: [schoolTypeId], references: [id])
  secondLang               SecondLanguage           @relation(fields: [secondLangId], references: [id])
  studentCourse            StudentCourse[]
  address                  Address[]
  QuizAttempt              QuizAttempt[]
  transactions             Transaction[]
  Comment                  Comment[]
  Review                   Review[]
  studentLectureProgresses StudentLectureProgress[]
}

model WithdrawRequest {
  id                Int              @id @default(autoincrement())
  userId            Int
  userType          WithdrawUserType
  amount            Decimal          @db.Decimal(10, 2)
  status            WithdrawStatus   @default(PENDING)
  paymentMethod     PaymentMethod
  phoneNumber       String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  accountHolderName String
  notes             String?
  adminNotes        String?
  processedBy       Int?
  processedAt       DateTime?
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin             User?            @relation("ProcessedWithdraws", fields: [processedBy], references: [id])
}

enum PaymentMethod {
  INSTAPAY
  EWALLET
}

enum WithdrawStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum WithdrawUserType {
  TEACHER
  STUDENT
}

model Government {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  cities  City[]
  Student Student[]
  Address Address[]
}

model City {
  id           Int        @id @default(autoincrement())
  name         String
  governmentId Int
  government   Government @relation(fields: [governmentId], references: [id])
  students     Student[]
  Address      Address[]

  @@unique([name, governmentId])
}

model EducationType {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  grade    Grade[]
  students Student[]
  teacher  Teacher[]
}

model Division {
  id       Int       @id @default(autoincrement())
  name     String
  gradeId  Int
  book     Book[]
  courses  Course[]
  grade    Grade     @relation(fields: [gradeId], references: [id])
  lectures Lecture[]
  students Student[]
  teachers Teacher[] @relation("DivisionToTeacher")

  @@unique([gradeId, name])
}

model SecondLanguage {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  students Student[]
}

model SchoolType {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  students Student[]
}

model Grade {
  id              Int           @id @default(autoincrement())
  name            String
  educationTypeId Int
  book            Book[]
  courses         Course[]
  division        Division[]
  educationType   EducationType @relation(fields: [educationTypeId], references: [id])
  lecture         Lecture[]
  students        Student[]
  teacher         Teacher[]     @relation("GradeToTeacher")

  @@unique([educationTypeId, name])
}

model Teacher {
  id              Int           @id
  bio             String?
  isActive        Boolean       @default(false)
  educationTypeId Int
  socialMedia     Json?         @default("{}")
  book            Book[]
  courses         Course[]
  Lecture         Lecture[]
  educationType   EducationType @relation(fields: [educationTypeId], references: [id])
  user            User          @relation(fields: [id], references: [id], onDelete: Cascade)
  division        Division[]    @relation("DivisionToTeacher")
  grade           Grade[]       @relation("GradeToTeacher")
  Quiz            Quiz[]
  transactions    Transaction[]
  subjectId       Int
  subject         Subject      @relation(fields: [subjectId], references: [id])
  Comment         Comment[]
}

model Subject {
  id      Int       @id @default(autoincrement())
  name    String
  teacher Teacher[]
  Course  Course[]
  books   Book[]

  @@unique([name])
}

model Guardian {
  id          Int       @id
  phoneNumber String    @unique
  user        User      @relation(fields: [id], references: [id], onDelete: Cascade)
  students    Student[]
}

model Admin {
  id   Int  @id
  user User @relation(fields: [id], references: [id], onDelete: Cascade)
}

model PlatformSetting {
  id                    Int     @id @default(autoincrement())
  key                   String  @unique
  teacherRegistration   Boolean @default(true)
  platformPercentage    Decimal @default(0.1) @db.Decimal(3, 2)
  minimumWithdrawAmount Decimal @default(10) @db.Decimal(10, 2)
}

enum Gender {
  MALE
  FEMALE
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
  GUARDIAN
}
